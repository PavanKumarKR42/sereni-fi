<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=390, initial-scale=1.0" />
    <title>Meditate to Earn</title>

    <meta name="fc:miniapp" content='{
    "version":"1",
    "imageUrl":"https://sereni-fi-pfb8.vercel.app/image.png",
    "button":{
      "title":"Serni-fi",
      "action":{
        "type":"launch_frame",
        "name":"Meditate to Earn",
        "url":"https://sereni-fi-pfb8.vercel.app/",
        "splashImageUrl":"https://sereni-fi-pfb8.vercel.app/splash.png",
        "splashBackgroundColor":"#111111"
      }
    }
  }' />

    <style>
      body {
        margin:0;background:#111;color:#fff;
        font-family:Inter,system-ui,sans-serif;
        display:flex;flex-direction:column;
        align-items:center;justify-content:center;
        min-height:100vh;max-width:390px;margin-inline:auto;
        text-align:center;
      }
      h1 { font-size:22px; margin-bottom:16px; }
      #timer { font-size:48px; margin:12px 0; font-weight:700; }
      #tokens { font-size:18px; margin:12px 0; }
      button {
        padding:12px;background:#ffd166;color:#000;
        border:none;border-radius:10px;font-weight:800;
        width:90%;cursor:pointer;margin:8px auto;
      }
      button:disabled { background:#666;color:#ccc;cursor:not-allowed; }
      .toast {
        position:fixed;bottom:14px;left:50%;transform:translateX(-50%);
        background:rgba(255,255,255,.12);backdrop-filter:blur(8px);
        color:#fff;border:1px solid rgba(255,255,255,.2);
        border-radius:14px;padding:10px 14px;font-weight:600;
        max-width:360px;width:calc(100% - 24px);
        box-shadow:0 8px 30px rgba(0,0,0,.5);display:none;z-index:9999;
      }
      .toast.show { display:block; animation:fadeIn .25s ease; }
      @keyframes fadeIn { from{opacity:0;transform:translate(-50%,10px)} to{opacity:1;transform:translate(-50%,0)} }
    </style>
</head>
<body>
    <h1>üßò Meditate to Earn</h1>
    <div id="timer">0s</div>
    <div id="tokens">Tokens: 0</div>
    <button id="startBtn">Start Meditation</button>
    <button id="stopBtn" disabled>Stop & Claim</button>
    <div id="toast" class="toast"></div>

    <script type="module">
      import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
      import {
        createConfig, connect, switchChain,
        writeContract, getAccount, http
      } from 'https://esm.sh/@wagmi/core';
      import { base } from 'https://esm.sh/@wagmi/core/chains';
      import { farcasterMiniApp } from 'https://esm.sh/@farcaster/miniapp-wagmi-connector';

      sdk.actions.ready({ disableNativeGestures: true });

      // UI refs
      const timerEl = document.getElementById('timer');
      const tokensEl = document.getElementById('tokens');
      const startBtn = document.getElementById('startBtn');
      const stopBtn = document.getElementById('stopBtn');
      const toastEl = document.getElementById('toast');

      function showToast(html, ms=3500){
        toastEl.innerHTML=html;
        toastEl.classList.add('show');
        setTimeout(()=>toastEl.classList.remove('show'), ms);
      }

      // Hardcoded ABI and Address
      const CONTRACT_ADDR = "0x134B36982726FA535C43d464e72E9fb239a58e9d";
      const CONTRACT_ABI = [
        { "inputs": [{ "internalType": "address", "name": "_token", "type": "address" }], "stateMutability": "nonpayable", "type": "constructor" },
        { "anonymous": false, "inputs": [{ "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "ContractFunded", "type": "event" },
        { "anonymous": false, "inputs": [
          { "indexed": true, "internalType": "address", "name": "user", "type": "address" },
          { "indexed": false, "internalType": "uint256", "name": "amount", "type": "uint256" }
        ], "name": "RewardClaimed", "type": "event" },
        { "stateMutability": "payable", "type": "fallback" },
        { "inputs": [{ "internalType": "uint256", "name": "secondsMeditated", "type": "uint256" }], "name": "claimReward", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [{ "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "fundContract", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [], "name": "lastFundTime", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "owner", "outputs": [{ "internalType": "address", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
        { "inputs": [], "name": "rewardPerSecond", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" },
        { "inputs": [{ "internalType": "uint256", "name": "_rewardPerSecond", "type": "uint256" }], "name": "setRewardPerSecond", "outputs": [], "stateMutability": "nonpayable", "type": "function" },
        { "inputs": [], "name": "token", "outputs": [{ "internalType": "contract IERC20", "name": "", "type": "address" }], "stateMutability": "view", "type": "function" },
        { "stateMutability": "payable", "type": "receive" }
      ];

      // wagmi config
      const config = createConfig({
        chains:[base],
        transports:{ [base.id]: http() }
      });

      // Meditation timer logic
      let seconds = 0, timer = null;

      startBtn.onclick = () => {
        seconds = 0;
        timerEl.textContent = `0s`;
        tokensEl.textContent = `Tokens: 0`;
        startBtn.disabled = true;
        stopBtn.disabled = false;
        timer = setInterval(()=>{
          seconds++;
          timerEl.textContent = `${seconds}s`;
          tokensEl.textContent = `Tokens: ${seconds}`;
        }, 1000);
      };

      stopBtn.onclick = async () => {
        clearInterval(timer);
        startBtn.disabled = false;
        stopBtn.disabled = true;
        
        try {
          // Check for account connection and connect if necessary
          let userAccount = getAccount(config);
          if (!userAccount.address) {
            await connect(config, { connector: farcasterMiniApp() });
            userAccount = getAccount(config);
            if (!userAccount.address) {
              throw new Error('User rejected wallet connection.');
            }
          }

          // Switch to the correct chain (Base)
          await switchChain(config, { chainId: base.id });

          // Call the smart contract function to claim rewards
          const txHash = await writeContract(config, {
            address: CONTRACT_ADDR,
            abi: CONTRACT_ABI,
            functionName: 'claimReward',
            args: [BigInt(seconds)]
          });

          showToast(`üéâ Claimed ${seconds} tokens! <a target="_blank" href="https://basescan.org/tx/${txHash}">view</a>`, 5000);
        } catch(e) {
          console.error("Claim failed:", e);
          showToast('‚ùå Claim failed.');
        }
      };
    </script>
</body>
</html>